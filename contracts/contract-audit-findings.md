# Contract Audit Findings - Rare Coin V2

## rare-erc20.sol (Token Contract)

### 游댮 Critical Issues

1. **Reentrancy Vulnerability**
   - `transferFrom()` doesn't use checks-effects-interactions pattern
   - State changes happen after external calls in some paths
   - **Fix:** Use ReentrancyGuard modifier

2. **Manager Can Change Token Metadata At Will**
   - `setName()` and `setSymbol()` allow unlimited changes to name/symbol
   - Breaks ERC20 expectations and can confuse users/DApps
   - **Fix:** Lock metadata after deployment or add timelock/multisig

3. **Missing Zero Address Validation**
   - Constructor doesn't validate `_ftnAddress != address(0)`
   - **Fix:** Add `require(_ftnAddress != address(0), "Invalid address")`

### 游리 Medium Issues

4. **No Events for Metadata Changes**
   - `setName()` and `setSymbol()` don't emit events
   - **Fix:** Add `event NameChanged(string oldName, string newName)` etc.

5. **Misleading approve() Require**
   - `require(balanceOf[msg.sender] >= _value)` is incorrect - you can approve more than you own
   - **Fix:** Remove this check (standard ERC20 allows approving more than balance)

6. **Redundant Assert Statements**
   - Multiple `assert()` calls that duplicate `require()` checks
   - **Fix:** Remove redundant assertions

7. **Old Solidity Version**
   - Using `^0.6.0`, should use `^0.8.20` for modern security features
   - **Fix:** Upgrade to Solidity 0.8.x (built-in overflow protection)

---

## rare-fountain-v6.sol (Distribution Contract)

### 游댮 Critical Issues

1. **Reentrancy Vulnerability in claim()**
   ```solidity
   rare.transfer(payable(msg.sender), claimerAmt);  // External call BEFORE state update
   checkReg[msg.sender] = false;  // State update AFTER external call
   ```
   - Attacker could call claim() recursively
   - **Fix:** Move state updates before external calls, use ReentrancyGuard

2. **Reentrancy Vulnerability in claimBounty()**
   - Multiple `rare.transfer()` calls before critical state updates
   - Pool balance updated AFTER transfers
   - **Fix:** Use checks-effects-interactions pattern

3. **Gas Refund Griefing**
   - Bounty hunters can manipulate gas calculations
   - Fixed gas price (1 gwei) may not match actual tx cost
   - **Fix:** Remove gas refund or use Oracle for accurate pricing

### 游리 Medium Issues

4. **Check Logic Inverted**
   - `checkRegThis()` and `checkRegNext()` have inverted logic
   - Period 2 checks checkReg (period 1) and vice versa
   - **Fix:** Swap the mapping references

5. **No Emergency Stop**
   - No way to pause the contract if bug is found
   - **Fix:** Add Pausable modifier

6. **Manager Functions Have No Timelock**
   - Critical changes can happen instantly
   - **Fix:** Add timelock or multisig for manager functions

7. **Missing Zero Address Checks**
   - `setContracts()`, `setManager()` don't validate addresses
   - **Fix:** Add zero address checks

8. **Block Manipulation Risk**
   - Uses `block.number` which miners can influence
   - **Fix:** Consider using block.timestamp with time-based windows

9. **calcDistAmt() May Return Incorrect Value**
   - Doesn't account for actual pool balance properly
   - Division before validation could cause issues
   - **Fix:** Add more robust calculation

10. **Old Solidity Version**
    - Using `^0.6.0`
    - **Fix:** Upgrade to 0.8.x

11. **Unsafe adminWithdraw()**
    - No validation of withdrawal amount beyond threshold
    - **Fix:** Add more granular controls or use pull-over-push pattern

---

## Recommended Priority

| Priority | Issue | Contract | Impact |
|----------|-------|----------|--------|
| 游댮 P0 | Reentrancy in claimBounty() | rare-fountain | CRITICAL - Funds loss |
| 游댮 P0 | Reentrancy in claim() | rare-fountain | CRITICAL - Funds loss |
| 游댮 P1 | Metadata changes uncontrolled | rare-erc20 | HIGH - Trust issue |
| 游리 P2 | Zero address validations | Both | MEDIUM - Could break contract |
| 游리 P2 | Gas refund mechanism | rare-fountain | MEDIUM - Economic issue |
| 游리 P3 | Solidity version upgrade | Both | MEDIUM - Security best practice |
| 游리 P4 | Emergency stop | rare-fountain | LOW - Safety feature |

---

## Next Steps

1. **Address P0/P1 issues first** before any deployment
2. **Consider using OpenZeppelin contracts** for security patterns:
   - ERC20 (instead of custom implementation)
   - ReentrancyGuard
   - Pausable
   - Ownable (with timelock extension)
3. **Get professional audit** after fixes are implemented
4. **Test on testnet** extensively before mainnet deployment

---

*Generated by Felix - Director of Rare Enterprises*
*Date: 2026-02-24*
